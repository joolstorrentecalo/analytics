-- This will be a list of only the opps that are eligible open pipeline and closing in the quarter, per quarter.
with first_day_flag AS  (
    SELECT DISTINCT
        DIM_CRM_OPPORTUNITY_ID as starting_opp_id,
        SNAPSHOT_FISCAL_QUARTER_DATE as starting_snapshot_fiscal_quarter_date
    FROM prod.RESTRICTED_SAFE_COMMON_MART_SALES.MART_CRM_OPPORTUNITY_DAILY_SNAPSHOT
    LEFT JOIN prod.common.DIM_DATE
    ON MART_CRM_OPPORTUNITY_DAILY_SNAPSHOT.SNAPSHOT_DATE = DIM_DATE.DATE_ACTUAL
    WHERE fiscal_year = '2025'-- just fy25
        AND STAGE_NAME NOT IN  ('0-Pending Acceptance', '00-Pre Opportunity', '9-Unqualified', '10-Duplicate') --filters out unqualified open opps
        AND (IS_OPEN = TRUE OR CLOSE_DATE = SNAPSHOT_FISCAL_QUARTER_DATE) -- is open, or closed day 1
            AND IS_ELIGIBLE_OPEN_PIPELINE = TRUE                           -- is eligible open pipe
            AND SNAPSHOT_FISCAL_QUARTER_DATE = CLOSE_FISCAL_QUARTER_DATE    --is closing this snapshot quarter on day 1
            AND close_fiscal_quarter_date IS NOT NULL                       -- has a close date
            AND SNAPSHOT_DATE = SNAPSHOT_FISCAL_QUARTER_DATE               -- is first day of quarter
            ),

-- this just filters down mart_crm_opportunity
base as (
    SELECT DIM_CRM_OPPORTUNITY_ID
        , OPPORTUNITY_NAME
        , SNAPSHOT_DATE
        , SNAPSHOT_FISCAL_QUARTER_DATE
        , CLOSE_DATE
        , CLOSE_FISCAL_QUARTER_DATE
        , fiscal_quarter_name_fy as snapshot_fiscal_quarter_name_fy

--      flags
         , IS_OPEN
        , is_closed
        , IS_ELIGIBLE_OPEN_PIPELINE
        , FPA_MASTER_BOOKINGS_FLAG
        , IS_WON
        , IS_LOST
--      measure
         , net_arr

--      dimensions
        , REPORT_AREA
        , REPORT_GEO
        , REPORT_REGION
        , REPORT_AREA OPPORTUNITY_OWNER_USER_AREA
        , REPORT_GEO OPPORTUNITY_OWNER_USER_GEO
        , REPORT_REGION OPPORTUNITY_OWNER_USER_REGION
        , SALES_QUALIFIED_SOURCE_NAME
        , ORDER_TYPE_GROUPED
        , stage_name
        , DEAL_PATH_NAME
        , LAST_DAY_OF_FISCAL_QUARTER
         , REPORT_ROLE_LEVEL_1
         , REPORT_ROLE_LEVEL_2
    ,      CASE
                WHEN report_role_level_2 IS NULL
                    THEN report_role_level_1
                ELSE report_role_level_2
            END AS role_level_2,
            CASE
                WHEN report_role_level_3 IS NULL AND report_role_level_2 IS NULL
                    THEN report_role_level_1
                WHEN report_role_level_3 IS NULL AND report_role_level_2 IS NOT NULL
                    THEN report_role_level_2
                WHEN report_role_level_3 IS NOT NULL AND report_role_level_3 LIKE ('EMEA_COMM_NEUR%')
                    THEN report_role_level_4
                WHEN report_role_level_3 LIKE ('EMEA_META%') THEN 'EMEA_META'
                WHEN report_role_level_3 LIKE ('EMEA_TELCO%') THEN 'EMEA_TELCO'
                WHEN report_role_level_3 LIKE ('APJ_JAPAN%') THEN 'APJ_JAPAN'
                ELSE report_role_level_3
            END AS role_level_3
        ,
--      flags the opps that shouldnt be considered pipe opps
         CASE
             WHEN STAGE_NAME NOT IN
             ('0-Pending Acceptance', '00-Pre Opportunity', '9-Unqualified', '10-Duplicate') THEN TRUE
         END AS in_pipe
        , DAY_OF_FISCAL_QUARTER as snapshot_day_of_fiscal_quarter
    FROM prod.RESTRICTED_SAFE_COMMON_MART_SALES.MART_CRM_OPPORTUNITY_DAILY_SNAPSHOT
    LEFT JOIN prod.common.DIM_DATE
    ON MART_CRM_OPPORTUNITY_DAILY_SNAPSHOT.SNAPSHOT_DATE = DIM_DATE.DATE_ACTUAL
    WHERE   FISCAL_YEAR = '2025'
    AND (snapshot_date = LAST_DAY_OF_FISCAL_QUARTER -- last day of quarter
    OR snapshot_date = FIRST_DAY_OF_FISCAL_QUARTER -- first day of quarter)
    OR (snapshot_day_of_fiscal_quarter % 5 = 0) )   -- 7th day
    )

SELECT *,
       -- movement categories - since we are only looking at opps that were open and predicted to close this quarter, we can use the predicted close quarter on future days to categorize
       CASE
           WHEN CLOSE_FISCAL_QUARTER_DATE > SNAPSHOT_FISCAL_QUARTER_DATE AND IS_OPEN THEN 'push'
            WHEN CLOSE_FISCAL_QUARTER_DATE > SNAPSHOT_FISCAL_QUARTER_DATE AND IS_WON = TRUE THEN 'pushed and closed won'
            WHEN CLOSE_FISCAL_QUARTER_DATE > SNAPSHOT_FISCAL_QUARTER_DATE AND STAGE_NAME = '8-Closed Lost' THEN 'pushed and closed lost'
            WHEN CLOSE_FISCAL_QUARTER_DATE = SNAPSHOT_FISCAL_QUARTER_DATE AND IS_OPEN THEN 'open'
            WHEN CLOSE_FISCAL_QUARTER_DATE = SNAPSHOT_FISCAL_QUARTER_DATE AND IS_WON = TRUE THEN 'closed won'
            WHEN CLOSE_FISCAL_QUARTER_DATE = SNAPSHOT_FISCAL_QUARTER_DATE AND IS_OPEN = FALSE AND IS_WON != TRUE THEN 'closed lost'
        ELSE 'other' END as movement_categories
FROM first_day_flag
LEFT JOIN base
ON first_day_flag.starting_opp_id = base.DIM_CRM_OPPORTUNITY_ID
AND first_day_flag.starting_snapshot_fiscal_quarter_date = base.SNAPSHOT_FISCAL_QUARTER_DATE